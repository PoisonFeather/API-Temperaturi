<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="refresh" content="30">
    <title>Temperature Comparison</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script> <!-- Zoom plugin -->
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #2c3e50;
            color: #ecf0f1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .content-wrapper {
            text-align: center;
            width: 100%;
            height: 100%;
            overflow-y: auto;
        }

        .temperature-info {
            margin: 20px 0;
        }

        .temperature-info p {
            font-size: 1.2em;
            margin: 10px 0;
        }

        canvas {
            max-width: 100%;
            height: auto;
        }

        .canvas-wrapper {
            margin-bottom: 20px;
        }

        @media (max-width: 600px) {
            .temperature-info p {
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <div class="container content-wrapper">
        <div class="row">
            <div class="col text-center">
                <div class="temperature-info">
                    <p class="lead">Current Outside Temperature: <span id="outsideTemp" class="font-weight-bold">Loading...</span>°C</p>
                </div>
                <div id="roomCharts"></div>
            </div>
        </div>
    </div>
    <script>
        let charts = {};  // Obiect global pentru a stoca graficele existente
        let cachedData = null;  // Pentru caching

        // Funcție care filtrează datele pentru ultimele 24 de ore
        function filterLast24Hours(dataArray) {
            const now = new Date();
            const hoursInMillis = 24 * 60 * 60 * 1000; // 24 de ore în milisecunde

            return dataArray.filter(item => {
                const itemTime = new Date(item[0]); // Presupunem că prima coloană este timpul
                return (now - itemTime) <= hoursInMillis; // Păstrează doar datele din ultimele 24 de ore
            });
        }

        // Funcție pentru actualizarea graficelor existente
        function updateChart(chart, newLabels, newData) {
            chart.data.labels = newLabels;  // Actualizează etichetele
            chart.data.datasets.forEach((dataset, i) => {
                dataset.data = newData[i];  // Actualizează dataseturile
            });
            chart.update();  // Reîmprospătează graficul
        }

        async function fetchData() {
            try {
                const response = await fetch('/data');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();
                
                // Dacă datele sunt identice cu cele din cache, returnăm cache-ul
                if (cachedData && JSON.stringify(data) === JSON.stringify(cachedData)) {
                    return cachedData;
                }

                cachedData = data;  // Actualizăm cache-ul
                return data;
            } catch (error) {
                console.error('Fetch data error:', error);
                document.getElementById('outsideTemp').textContent = "Error loading data";
                return cachedData || {};  // În caz de eroare, returnează cache-ul vechi
            }
        }

        async function createCharts() {
            const data = await fetchData();
            const filteredOutsideTempsData = filterLast24Hours(data.outside_temperatures);
            const outsideTemps = filteredOutsideTempsData.map(item => item[1]);
            const outsideTimes = filteredOutsideTempsData.map(item => new Date(item[0]).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }));

            document.getElementById('outsideTemp').textContent = data.current_outside_temp || "N/A";

            const roomChartsContainer = document.getElementById('roomCharts');
            roomChartsContainer.innerHTML = ''; // Șterge graficele existente

            Object.keys(data.room_temperatures).forEach(roomId => {
                const roomData = filterLast24Hours(data.room_temperatures[roomId]);
                const roomTemps = roomData.map(item => parseFloat(item[1]));
                const roomTimes = roomData.map(item => new Date(item[3]).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }));
                const latestRoomTemp = roomTemps[roomTemps.length - 1]; // Ultima temperatură

                // Alertă vizuală pentru temperaturi critice
                const canvasWrapper = document.createElement('div');
                canvasWrapper.classList.add('canvas-wrapper');
                const title = document.createElement('h3');
                title.textContent = `Room ${roomId} - Current Temperature: ${latestRoomTemp}°C`;

                if (latestRoomTemp > 30) {
                    title.style.color = 'red';  // Subliniează temperatura critică
                    alert(`Temperatura în camera ${roomId} este peste limita normală!`);
                }

                const canvas = document.createElement('canvas');
                canvasWrapper.appendChild(title);
                canvasWrapper.appendChild(canvas);
                roomChartsContainer.appendChild(canvasWrapper);

                const ctx = canvas.getContext('2d');
                
                const isMobile = window.innerWidth < 600;
                const dataPointsToShow = isMobile ? 10 : 50;  // Arată mai puține puncte pe mobil

                const filteredRoomTemps = roomTemps.slice(-dataPointsToShow);
                const filteredRoomTimes = roomTimes.slice(-dataPointsToShow);

                // Creare grafic nou sau actualizare grafic existent
                if (charts[roomId]) {
                    updateChart(charts[roomId], filteredRoomTimes, [filteredRoomTemps, outsideTemps.slice(-dataPointsToShow)]);
                } else {
                    charts[roomId] = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: filteredRoomTimes,
                            datasets: [
                                {
                                    label: `Room ${roomId} Temperature`,
                                    data: filteredRoomTemps,
                                    borderColor: 'rgba(52, 152, 219, 1)', // Albastru
                                    backgroundColor: 'rgba(52, 152, 219, 0.2)', // Umplere albastră deschisă
                                    fill: true,
                                },
                                {
                                    label: 'Outside Temperature',
                                    data: outsideTemps.slice(-dataPointsToShow),
                                    borderColor: 'rgba(231, 76, 60, 1)', // Roșu
                                    backgroundColor: 'rgba(231, 76, 60, 0.2)', // Umplere roșie deschisă
                                    fill: true,
                                }
                            ]
                        },
                        options: {
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Time',
                                        color: '#ecf0f1'
                                    },
                                    ticks: {
                                        color: '#ecf0f1'
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: 'Temperature (°C)',
                                        color: '#ecf0f1'
                                    },
                                    ticks: {
                                        color: '#ecf0f1'
                                    }
                                }
                            },
                            plugins: {
                                zoom: {
                                    pan: {
                                        enabled: true,
                                        mode: 'x'
                                    },
                                    zoom: {
                                        enabled: true,
                                        mode: 'x'
                                    }
                                },
                                legend: {
                                    labels: {
                                        color: '#ecf0f1'
                                    }
                                }
                            }
                        }
                    });
                }
            });
        }

        createCharts();
        setInterval(createCharts, 60000);  // Actualizează graficele la fiecare 60 de secunde
    </script>
</body>
</html>
